-- For HELOC Tables Comparison
WITH source_counts AS (
  SELECT 
    as_of_month,
    COUNT(*) as source_count,
    COUNT(DISTINCT mcdash_loan_identifier) as distinct_loans,
    MIN(mcdash_loan_identifier) as sample_loan_id
  FROM bk_mpo_raw_v1.heloc
  GROUP BY as_of_month
),
target_counts AS (
  SELECT 
    as_of_month,
    COUNT(*) as target_count,
    COUNT(DISTINCT mcdash_loan_identifier) as distinct_loans
  FROM test_bk_mpo.heloc_silver
  GROUP BY as_of_month
)
SELECT 
  COALESCE(s.as_of_month, t.as_of_month) as as_of_month,
  s.source_count,
  t.target_count,
  s.source_count - t.target_count as count_difference,
  s.distinct_loans as source_distinct_loans,
  t.distinct_loans as target_distinct_loans,
  s.sample_loan_id
FROM source_counts s
FULL OUTER JOIN target_counts t ON s.as_of_month = t.as_of_month
ORDER BY as_of_month;

-- For Loan Month Tables Comparison
WITH source_counts AS (
  SELECT 
    as_of_month,
    COUNT(*) as source_count,
    COUNT(DISTINCT loan_id) as distinct_loans,
    MIN(loan_id) as sample_loan_id
  FROM bk_mpo_raw_v1.loan_month
  GROUP BY as_of_month
),
target_counts AS (
  SELECT 
    as_of_month,
    COUNT(*) as target_count,
    COUNT(DISTINCT loan_id) as distinct_loans
  FROM test_bk_mpo.loan_month_silver
  GROUP BY as_of_month
)
SELECT 
  COALESCE(s.as_of_month, t.as_of_month) as as_of_month,
  s.source_count,
  t.target_count,
  s.source_count - t.target_count as count_difference,
  s.distinct_loans as source_distinct_loans,
  t.distinct_loans as target_distinct_loans,
  s.sample_loan_id
FROM source_counts s
FULL OUTER JOIN target_counts t ON s.as_of_month = t.as_of_month
ORDER BY as_of_month;

-- For Loss Mitigation Tables Comparison
WITH source_counts AS (
  SELECT 
    as_of_month,
    COUNT(*) as source_count,
    COUNT(DISTINCT lps_loan_id) as distinct_loans,
    MIN(lps_loan_id) as sample_loan_id
  FROM bk_mpo_raw_v1.loan_month_loss_mit
  GROUP BY as_of_month
),
target_counts AS (
  SELECT 
    as_of_month,
    COUNT(*) as target_count,
    COUNT(DISTINCT lps_loan_id) as distinct_loans
  FROM test_bk_mpo.loan_month_loss_mit_silver
  GROUP BY as_of_month
)
SELECT 
  COALESCE(s.as_of_month, t.as_of_month) as as_of_month,
  s.source_count,
  t.target_count,
  s.source_count - t.target_count as count_difference,
  s.distinct_loans as source_distinct_loans,
  t.distinct_loans as target_distinct_loans,
  s.sample_loan_id
FROM source_counts s
FULL OUTER JOIN target_counts t ON s.as_of_month = t.as_of_month
ORDER BY as_of_month;

-- Additional Detailed Comparison Query (can be used for any of the tables)
-- Replace table_name and id_column as needed
WITH missing_records AS (
  SELECT 
    s.as_of_month,
    s.<id_column>,
    'Missing in Target' as status
  FROM bk_mpo_raw_v1.<table_name> s
  LEFT JOIN test_bk_mpo.<table_name>_silver t 
    ON s.as_of_month = t.as_of_month 
    AND s.<id_column> = t.<id_column>
  WHERE t.<id_column> IS NULL
  
  UNION ALL
  
  SELECT 
    t.as_of_month,
    t.<id_column>,
    'Extra in Target' as status
  FROM test_bk_mpo.<table_name>_silver t
  LEFT JOIN bk_mpo_raw_v1.<table_name> s 
    ON s.as_of_month = t.as_of_month 
    AND s.<id_column> = t.<id_column>
  WHERE s.<id_column> IS NULL
)
SELECT 
  as_of_month,
  status,
  COUNT(*) as record_count,
  MIN(<id_column>) as sample_id
FROM missing_records
GROUP BY as_of_month, status
ORDER BY as_of_month, status;
