CREATE OR REPLACE FUNCTION get_exam_gpra_data()
RETURNS TABLE (
    Event_ID INTEGER,
    Entity TEXT,
    Exam_Analysis_Finalized DATE,
    Draft_to_Prudential DATE,
    Draft_From_Prudential DATE,
    GPRA_Due_Date DATE,
    GPRA_Calculated_Date DATE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        e.Event_ID,
        e.Entity,
        e.Exam_Analysis_Finalized,
        e.Draft_to_Prudential,
        e.Draft_From_Prudential,
        e.GPRA_Due_Date,
        CASE
            WHEN e.Exam_Analysis_Finalized IS NOT NULL AND e.Draft_to_Prudential IS NULL THEN
                workday(e.Exam_Analysis_Finalized, 45, 'scv3_rtp.holidays')
            WHEN e.Exam_Analysis_Finalized IS NOT NULL AND e.Draft_to_Prudential IS NOT NULL THEN
                NULL
            ELSE
                NULL
        END AS GPRA_Calculated_Date
    FROM 
        scv3_rtp.exams e;
END;
$$ LANGUAGE plpgsql;
