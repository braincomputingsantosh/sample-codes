WITH formatted_event_ids AS (
    SELECT unnest(string_to_array('11521,2521,5214,521', ',')) AS raw_event_id,
           'EID-' || LPAD(unnest(string_to_array('11521,2521,5214,521', ',')), 8, '0') AS formatted_event_id
),
simulation AS (
    SELECT 
        e.*,
        f.formatted_event_id,
        CASE
            WHEN e.Calendared IS NULL OR e.Calendared = '' THEN
                CASE
                    WHEN f.formatted_event_id IS NOT NULL THEN 'Yes'
                    ELSE 'No'
                END
            ELSE e.Calendared
        END AS proposed_est_calendared
    FROM public.exams e
    LEFT JOIN formatted_event_ids f ON e.Event_ID = f.formatted_event_id
)
SELECT * FROM simulation;
