CREATE OR REPLACE PROCEDURE update_est_calendared_mastered(event_id_list VARCHAR)
LANGUAGE plpgsql
AS $$
BEGIN
    -- Temporary table to hold event_ids from the list
    CREATE TEMP TABLE IF NOT EXISTS temp_event_ids (event_id VARCHAR PRIMARY KEY) ON COMMIT DROP;
    
    -- Empty the temporary table in case it already exists
    TRUNCATE temp_event_ids;
    
    -- Populate the temporary table with event_ids from the input list
    INSERT INTO temp_event_ids (event_id)
    SELECT unnest(string_to_array(event_id_list, ','));
    
    -- Update logic corrected for public.exams table
    UPDATE public.exams e
    SET est_calendared = CASE
        WHEN e.Calendared IS NULL OR e.Calendared = '' THEN
            CASE
                WHEN te.event_id IS NOT NULL THEN 'Yes'
                ELSE 'No'
            END
        ELSE e.Calendared
    END
    FROM temp_event_ids te
    WHERE e.Event_ID = te.event_id;
END;
$$;
