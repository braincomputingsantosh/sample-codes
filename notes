from pyspark.sql import SparkSession
from pyspark.sql.functions import max, month, year, current_date

def ingest_latest_month(source_table, target_table, truncate='no'):
    # Create SparkSession
    spark = SparkSession.builder.appName("IngestLatestMonth").getOrCreate()

    # Read source table
    df = spark.table(source_table)

    # Get the latest month and year
    latest_date = df.select(max("date")).collect()[0][0]
    latest_month = month(latest_date)
    latest_year = year(latest_date)

    # Filter data for the latest month
    latest_data = df.filter((month(df.date) == latest_month) & (year(df.date) == latest_year))

    # Write to target table
    if truncate.lower() == 'yes':
        latest_data.write.mode("overwrite").saveAsTable(target_table)
    else:
        latest_data.write.mode("append").saveAsTable(target_table)

    print(f"Data ingestion complete. Latest month data from {source_table} has been written to {target_table}.")

# Example usage
ingest_latest_month("source_table_name", "target_table_name", "no")
