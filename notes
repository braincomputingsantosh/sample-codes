import psycopg2
import pandas as pd
import yaml

# Load states from YAML file
with open("config.yaml", 'r') as file:
    config = yaml.safe_load(file)

states_to_update = config['states_to_update']

# Connect to your Citus CStore database
conn = psycopg2.connect("dbname=yourdbname user=yourusername password=yourpassword")
cur = conn.cursor()

batch_size = 100000
last_processed_file_id = 0

for state in states_to_update:
    print(f"Processing state: {state}")
    error_count = 0

    while True:
        try:
            # Fetch a batch of records into a Pandas DataFrame
            query = """
                SELECT file_id, segment, tbl 
                FROM census.sf1_temp 
                WHERE state = %s AND file_id > %s 
                ORDER BY file_id 
                LIMIT %s
            """
            df = pd.read_sql(query, conn, params=(state, last_processed_file_id, batch_size))

            if df.empty:
                break

            # Perform updates in bulk using the DataFrame
            for index, row in df.iterrows():
                update_query = """
                    UPDATE census.sf1_temp 
                    SET tbl = %s 
                    WHERE file_id = %s AND segment = %s AND tbl = %s
                """
                cur.execute(update_query, (row['new_tbl_value'], row['file_id'], row['segment'], row['tbl']))
                last_processed_file_id = row['file_id']

            # Commit the updates
            conn.commit()

        except Exception as e:
            print(f"Error processing state {state}: {e}")
            conn.rollback()
            error_count += 1

            if error_count > 10:
                print(f"Too many errors in state {state}, skipping to next state.")
                break

cur.close()
conn.close()


********* config.yaml ********
states_to_update:
  - state1
  - state2
  - state3
