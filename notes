from pyspark.sql import SparkSession
from pyspark.sql.functions import *

# Create input widgets
dbutils.widgets.text("source_schema", "bk_mpo_raw", "Source Schema")
dbutils.widgets.text("source_table", "loan_month_loss_mit", "Source Table")
dbutils.widgets.text("target_schema", "test_bk_mpo", "Target Schema")
dbutils.widgets.text("target_table", "loan_month_loss_mit", "Target Table")
dbutils.widgets.text("num_rows", "all", "Number of Rows (Enter 'all' for all rows)")
dbutils.widgets.text("where_clause", "", "WHERE Clause (Optional)")
dbutils.widgets.dropdown("write_mode", "overwrite", ["overwrite", "append"], "Write Mode")

def migrate_data(source_schema, source_table, target_schema, target_table, num_rows, where_clause, write_mode):
    spark = SparkSession.builder.appName("DataMigration").getOrCreate()

    # Set the database
    spark.sql(f"USE {source_schema}")

    # Construct the SQL query
    query = f"SELECT * FROM {source_schema}.{source_table}"
    if where_clause:
        query += f" WHERE {where_clause}"

    # Execute the query
    df = spark.sql(query)

    # Determine the number of rows to migrate
    if num_rows.lower() == 'all':
        rows_to_migrate = None  # We'll count after migration
    else:
        try:
            rows_to_migrate = int(num_rows)
            df = df.limit(rows_to_migrate)
        except ValueError:
            print("Invalid number of rows specified. Migrating all rows.")
            rows_to_migrate = None

    # Create the target schema if it doesn't exist
    spark.sql(f"CREATE SCHEMA IF NOT EXISTS {target_schema}")

    # Write data to the target table
    df.write.mode(write_mode).saveAsTable(f"{target_schema}.{target_table}")

    # Count rows after migration
    migrated_rows = spark.table(f"{target_schema}.{target_table}").count()
    
    # If we migrated all rows, update rows_to_migrate
    if rows_to_migrate is None:
        rows_to_migrate = migrated_rows

    # Print detailed information
    print("\n--- Data Migration Summary ---")
    print(f"Source: {source_schema}.{source_table}")
    print(f"Target: {target_schema}.{target_table}")
    print(f"Write Mode: {write_mode}")
    print(f"Rows Migrated: {rows_to_migrate}")
    print(f"Rows in Target Table After Migration: {migrated_rows}")
    if where_clause:
        print(f"WHERE Clause Applied: {where_clause}")
    print(f"Status: {'Completed' if rows_to_migrate > 0 else 'No rows migrated'}")
    print("-----------------------------\n")

# Get parameters from widgets
source_schema = dbutils.widgets.get("source_schema")
source_table = dbutils.widgets.get("source_table")
target_schema = dbutils.widgets.get("target_schema")
target_table = dbutils.widgets.get("target_table")
num_rows = dbutils.widgets.get("num_rows")
where_clause = dbutils.widgets.get("where_clause")
write_mode = dbutils.widgets.get("write_mode")

# Call the function
migrate_data(source_schema, source_table, target_schema, target_table, num_rows, where_clause, write_mode)
