DO $$
DECLARE
    state_rec record;
BEGIN
    FOR state_rec IN (SELECT DISTINCT state FROM census.sf1_temp ORDER BY state)
    LOOP
        BEGIN
            RAISE NOTICE 'Processing state: %', state_rec.state;
            PERFORM update_sf1_temp_batched(state_rec.state, 100000);
            RAISE NOTICE 'Completed processing state: %', state_rec.state;
            COMMIT;
        EXCEPTION WHEN OTHERS THEN
            RAISE WARNING 'Error processing state %: % %', state_rec.state, SQLERRM, SQLSTATE;
            ROLLBACK;
        END;
    END LOOP;
END $$;
